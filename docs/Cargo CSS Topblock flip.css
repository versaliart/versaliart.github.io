/* v1.3 */

:root{
  /* Tune these to taste */
  --flip-dur-enter: 650ms;  /* first flip = slower */
  --flip-dur-exit:  650ms;  /* unflip     = quicker */

  --flip-ease-enter: cubic-bezier(.2,.8,.2,1);
  --flip-ease-exit:  cubic-bezier(.4,0,.2,1);
  --flip-perspective: 1000px;
}

.flip-section { position: relative; perspective: var(--flip-perspective); }
.flip-top     { position: relative; isolation: isolate; }

/* Wrapper + faces fill the figure */
.flip-top .flip-inner{
  display: grid;
  transform-style: preserve-3d;
  transition-property: transform; /* important! */
  transition-duration: var(--flip-dur-enter);
  transition-timing-function: var(--flip-ease-enter);
  will-change: transform;
  width: 100%; height: 100%;
}
.flip-top .flip-front,
.flip-top .flip-back{
  grid-area: 1 / 1;
  width: 100%; height: 100%;
  -webkit-backface-visibility: hidden; backface-visibility: hidden;
}
.flip-top .flip-back{ transform: rotateY(180deg); pointer-events: none; }

/* Marker anchor is just an opt-in flag */
.flip-top a[href="#flip-top"]{ pointer-events: none; cursor: default; }

/* Flipped states (JS toggles .hover / .is-flipped) */
.flip-top.hover .flip-inner,
.flip-top.is-flipped .flip-inner { transform: rotateY(180deg); }

/* Directional timing (JS swaps these classes before each change) */
.flip-top.ease-enter .flip-inner{
  transition-duration: var(--flip-dur-enter);
  transition-timing-function: var(--flip-ease-enter);
}
.flip-top.ease-exit .flip-inner{
  transition-duration: var(--flip-dur-exit);
  transition-timing-function: var(--flip-ease-exit);
}

/* Motion safety */
@media (prefers-reduced-motion: reduce){
  .flip-top .flip-inner { transition: none !important; }
}


<script>
/* ===== Multi-Flip setup for only this section ===== */
(function(){
  function closestSection(el){
    while(el && el!==document.body){
      if(el.matches('.page-section, [data-section-id], section')) return el;
      el = el.parentElement;
    }
    return null;
  }
  function ready(fn){
    if(document.readyState!=='loading') fn();
    else document.addEventListener('DOMContentLoaded', fn, {once:true});
  }

  ready(function(){
    var scriptEl = document.currentScript;
    var section = closestSection(scriptEl);
    if(!section) return;
    section.classList.add('flip-section');

    // Find every Image Block in this section marked as a Top Block
    var blocks = Array.from(section.querySelectorAll('.sqs-block.image-block'))
      .filter(function(blk){ return !!blk.querySelector('a[href="#flip-top"]'); });

    if(!blocks.length){
      console.warn('FlipTop: No Image Blocks with href="#flip-top" in this section.');
      return;
    }

    blocks.forEach(function(block){
      if(block.__flipReady) return; // idempotent
      block.__flipReady = true;
      block.classList.add('flip-top');

      // Build flip DOM: .flip-inner > (.flip-front [original content], .flip-back [empty])
      var inner = document.createElement('div'); inner.className = 'flip-inner';
      var front = document.createElement('div'); front.className = 'flip-front';
      var back  = document.createElement('div'); back.className  = 'flip-back';

      while(block.firstChild){ front.appendChild(block.firstChild); }
      inner.appendChild(front); inner.appendChild(back);
      block.appendChild(inner);

      // Use the marker link as a trigger; never navigate
      var marker = front.querySelector('a[href="#flip-top"]');
      if(marker){
        marker.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          if (matchMedia('(hover: none), (pointer: coarse)').matches) {
            block.classList.add('is-flipped'); // mobile tap â†’ flip this block only
          }
        }, true);
      }

      // Also allow tapping anywhere on the Top Block (mobile) to flip
      block.addEventListener('click', function(){
        if (matchMedia('(hover: none), (pointer: coarse)').matches) {
          block.classList.add('is-flipped');
        }
      }, true);

      // Auto-reset when the block scrolls off-screen
      if('IntersectionObserver' in window){
        var io = new IntersectionObserver(function(entries){
          entries.forEach(function(entry){
            if(!entry.isIntersecting){ block.classList.remove('is-flipped'); }
          });
        }, {threshold: 0.05});
        io.observe(block);
      }
    });

    // Mobile convenience: tap blank space in the section to reset all flipped blocks
    section.addEventListener('click', function(e){
      if (!(matchMedia('(hover: none), (pointer: coarse)').matches)) return;
      if (!e.target.closest('a, button, [role="button"]')) {
        section.querySelectorAll('.flip-top.is-flipped').forEach(function(b){
          b.classList.remove('is-flipped');
        });
      }
    });
  });
})();
</script>
